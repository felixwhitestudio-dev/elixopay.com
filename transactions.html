<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายการธุรกรรม - Elixopay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-blue-600">
                            <i class="fas fa-wallet"></i> Elixopay
                        </h1>
                        <span class="text-gray-400">|</span>
                        <h2 class="text-lg font-medium text-gray-700">รายการธุรกรรมทั้งหมด</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard.html" class="text-gray-600 hover:text-blue-600">
                            <i class="fas fa-home mr-2"></i>Dashboard
                        </a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                            <i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-blue-100 rounded-lg p-3">
                            <i class="fas fa-receipt text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">ทั้งหมด</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalCount">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">สำเร็จ</p>
                            <p class="text-2xl font-bold text-green-600" id="successCount">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-yellow-100 rounded-lg p-3">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">รอดำเนินการ</p>
                            <p class="text-2xl font-bold text-yellow-600" id="pendingCount">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-purple-100 rounded-lg p-3">
                            <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">ยอดรวม</p>
                            <p class="text-xl font-bold text-purple-600" id="totalAmount">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
                        <select id="statusFilter" onchange="loadTransactions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">ทั้งหมด</option>
                            <option value="succeeded">สำเร็จ</option>
                            <option value="pending">รอดำเนินการ</option>
                            <option value="failed">ล้มเหลว</option>
                            <option value="cancelled">ยกเลิก</option>
                            <option value="refunded">คืนเงิน</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เรียงตาม</label>
                        <select id="sortField" onchange="loadTransactions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="created_at">วันที่สร้าง</option>
                            <option value="amount">จำนวนเงิน</option>
                            <option value="status">สถานะ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ลำดับ</label>
                        <select id="sortOrder" onchange="loadTransactions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="DESC">ล่าสุดก่อน</option>
                            <option value="ASC">เก่าสุดก่อน</option>
                        </select>
                    </div>

                    <div class="flex items-end">
                        <button onclick="loadTransactions()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sync mr-2"></i>รีเฟรช
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                <p class="mt-4 text-gray-600">กำลังโหลดข้อมูล...</p>
            </div>

            <!-- Transactions Table -->
            <div id="transactionsTable" class="hidden bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่/เวลา</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">คำอธิบาย</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนเงิน</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stripe ID</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsList" class="bg-white divide-y divide-gray-200">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 sm:px-6">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            แสดง <span id="showingFrom" class="font-medium">1</span> ถึง <span id="showingTo" class="font-medium">10</span> จาก <span id="totalRecords" class="font-medium">0</span> รายการ
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="previousPage()" id="prevBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-2"></i>ก่อนหน้า
                            </button>
                            <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                ถัดไป<i class="fas fa-chevron-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api-config.js"></script>
    <script src="/js/auth-guard.js" data-require-role="user"></script>
    <script>
        let authToken = null;
        let currentPage = 0;
        const itemsPerPage = 20;

        // Status badges
        const statusBadges = {
            'succeeded': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>สำเร็จ</span>',
            'pending': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"><i class="fas fa-clock mr-1"></i>รอดำเนินการ</span>',
            'failed': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-times-circle mr-1"></i>ล้มเหลว</span>',
            'cancelled': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800"><i class="fas fa-ban mr-1"></i>ยกเลิก</span>',
            'refunded': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800"><i class="fas fa-undo mr-1"></i>คืนเงิน</span>'
        };

        // Initialize after auth guard passes
        function initAfterAuth() {
            authToken = localStorage.getItem('token');
            if (!authToken) return; // guard will redirect if invalid
            loadStats();
            loadTransactions();
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/payments/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                if (result.success) {
                    const stats = result.data.stats;
                    document.getElementById('totalCount').textContent = stats.totalPayments;
                    document.getElementById('successCount').textContent = stats.completedPayments;
                    document.getElementById('pendingCount').textContent = stats.pendingPayments;
                    document.getElementById('totalAmount').textContent = `฿${stats.totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
                }
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        // Load transactions
        async function loadTransactions() {
            const status = document.getElementById('statusFilter').value;
            const sort = document.getElementById('sortField').value;
            const order = document.getElementById('sortOrder').value;
            const offset = currentPage * itemsPerPage;

            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('transactionsTable').classList.add('hidden');

            try {
                let url = `${API_CONFIG.BASE_URL}/payments?limit=${itemsPerPage}&offset=${offset}&sort=${sort}&order=${order}`;
                if (status) url += `&status=${status}`;

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                if (result.success) {
                    displayTransactions(result.data.payments);
                    updatePagination(result.data.pagination);
                }
            } catch (error) {
                console.error('Load error:', error);
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('transactionsTable').classList.remove('hidden');
            }
        }

        // Display transactions
        function displayTransactions(payments) {
            const tbody = document.getElementById('transactionsList');
            tbody.innerHTML = '';

            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">ไม่พบรายการธุรกรรม</td></tr>';
                return;
            }

            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const date = new Date(payment.created_at);
                const formattedDate = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-600">${payment.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${payment.description || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold text-gray-900">฿${parseFloat(payment.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${statusBadges[payment.status] || payment.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">${payment.payment_intent_id || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                        <a href="https://dashboard.stripe.com/test/payments/${payment.payment_intent_id}" target="_blank" class="text-blue-600 hover:text-blue-800 mr-3" title="ดูใน Stripe">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <button onclick="viewDetails('${payment.id}')" class="text-gray-600 hover:text-gray-800" title="รายละเอียด">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update pagination
        function updatePagination(pagination) {
            document.getElementById('totalRecords').textContent = pagination.total;
            document.getElementById('showingFrom').textContent = pagination.offset + 1;
            document.getElementById('showingTo').textContent = Math.min(pagination.offset + pagination.limit, pagination.total);

            document.getElementById('prevBtn').disabled = pagination.offset === 0;
            document.getElementById('nextBtn').disabled = !pagination.hasMore;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadTransactions();
            }
        }

        function nextPage() {
            currentPage++;
            loadTransactions();
        }

        // View details
        async function viewDetails(paymentId) {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/payments/${paymentId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const result = await response.json();
                if (result.success) {
                    alert(JSON.stringify(result.data.payment, null, 2));
                }
            } catch (error) {
                console.error('View details error:', error);
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('authRefreshToken');
            window.location.href = '/login.html';
        }

        // Initialize after DOM ready (auth-guard runs immediately)
        document.addEventListener('DOMContentLoaded', initAfterAuth);
    </script>
</body>
</html>
