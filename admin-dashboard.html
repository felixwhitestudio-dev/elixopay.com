<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Elixopay</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <style>
    :root {
      --primary-color: #2563eb;
      --sidebar-width: 280px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      margin: 0;
      display: flex;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: white;
      height: 100vh;
      border-right: 1px solid #e2e8f0;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      box-sizing: border-box;
    }

    .sidebar-logo {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-color);
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: #64748b;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover,
    .nav-item.active {
      background-color: #eff6ff;
      color: var(--primary-color);
    }

    .main-content {
      margin-left: var(--sidebar-width);
      padding: 2rem;
      width: calc(100% - var(--sidebar-width));
    }

    /* Verification Table */
    .verification-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .verification-table th,
    .verification-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-pending {
      background: #fff7ed;
      color: #c2410c;
    }

    .status-verified {
      background: #f0fdf4;
      color: #15803d;
    }

    .status-rejected {
      background: #fef2f2;
      color: #dc2626;
    }

    /* Document Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      width: 600px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .doc-preview {
      width: 100%;
      height: 300px;
      border: 1px solid #e2e8f0;
      margin: 1rem 0;
      object-fit: contain;
      background: #f8fafc;
    }
  </style>
</head>

<body>

  <nav class="sidebar">
    <div class="sidebar-logo">
      <i class="fas fa-shield-alt"></i> ELIXO ADMIN
    </div>
    <div class="nav-item active" onclick="switchTab('dashboard')">
      <i class="fas fa-home"></i> Dashboard
    </div>
    <div class="nav-item" onclick="switchTab('verifications')">
      <i class="fas fa-user-check"></i> Verifications
      <span id="pending-count"
        style="margin-left:auto; background:red; color:white; padding:2px 8px; border-radius:99px; font-size:0.75rem;">0</span>
    </div>
    <div class="nav-item" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </nav>

  <main class="main-content">
    <!-- Dashboard Overview -->
    <div id="view-dashboard" class="tab-view">
      <h1>Admin Overview</h1>
      <p>Welcome, Super Admin.</p>
    </div>

    <!-- Verification Queue -->
    <div id="view-verifications" class="tab-view" style="display:none;">
      <h1>Pending Verifications</h1>
      <table class="verification-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>User</th>
            <th>Email</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="verification-list">
          <!-- Loaded via JS -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between;">
        <h2>Review Application</h2>
        <button onclick="closeReviewModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
      </div>
      <div id="review-content">Loading...</div>
      <div style="margin-top:2rem; display:flex; gap:1rem;">
        <button onclick="submitReview('approve')" class="btn btn-primary"
          style="flex:1; background:#16a34a;">Approve</button>
        <button onclick="submitReview('reject')" class="btn btn-primary"
          style="flex:1; background:#dc2626;">Reject</button>
      </div>
      <textarea id="reject-reason" placeholder="Reason for rejection (required if rejecting)"
        style="width:100%; margin-top:1rem; padding:0.5rem; border:1px solid #ddd;"></textarea>
    </div>
  </div>

  <script src="js/api-config.js"></script>
  <script>
    let currentUserId = null;

    // On Load
    document.addEventListener('DOMContentLoaded', () => {
      fetchVerifications();
    });

    function switchTab(tab) {
      document.querySelectorAll('.tab-view').forEach(el => el.style.display = 'none');
      document.getElementById(`view-${tab}`).style.display = 'block';
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');
      if (tab === 'verifications') fetchVerifications();
    }

    async function fetchVerifications() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch('/api/v1/admin/verifications', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        const tbody = document.getElementById('verification-list');
        tbody.innerHTML = '';

        if (data.data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem;">No pending verifications</td></tr>';
          document.getElementById('pending-count').textContent = '0';
          return;
        }

        document.getElementById('pending-count').textContent = data.data.length;

        data.data.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td>${user.email}</td>
                        <td><span class="status-badge status-pending">${user.verification_status}</span></td>
                        <td><button onclick="openReview('${user.id}')" style="padding:0.5rem 1rem; cursor:pointer;">Review</button></td>
                    `;
          tbody.appendChild(tr);
        });

      } catch (e) {
        console.error(e);
      }
    }

    async function openReview(userId) {
      currentUserId = userId;
      const modal = document.getElementById('reviewModal');
      modal.style.display = 'flex';
      const content = document.getElementById('review-content');
      content.innerHTML = 'Loading details...';

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/v1/admin/verifications/${userId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();

        const user = data.data.user;
        const docs = data.data.documents;

        let html = `
                    <p><strong>User:</strong> ${user.first_name} ${user.last_name} (${user.email})</p>
                    <h3>Documents</h3>
                `;

        if (docs.length === 0) {
          html += '<p>No documents uploaded.</p>';
        } else {
          docs.forEach(doc => {
            // Assuming images for now. If PDF, need link.
            const isImg = doc.file_path.match(/\.(jpeg|jpg|png)$/i);
            const cleanPath = doc.file_path.replace('uploads/', ''); // Adjust based on how we serve static files
            // We need to serve uploads folder statically!
            const url = `/uploads/${cleanPath}`;

            // Fix: backend saves absolute path or relative?
            // Controller: req.file.path -> "uploads/filename"
            // So URL should be /filename if we mount uploads to root/uploads?
            // Let's assume we mount app.use('/uploads', express.static('uploads'))

            html += `
                            <div style="margin-bottom:1rem;">
                                <strong>${doc.type}</strong>
                                ${isImg ? `<img src="/${doc.file_path}" class="doc-preview">` : `<a href="/${doc.file_path}" target="_blank">View Document</a>`}
                            </div>
                        `;
          });
        }
        content.innerHTML = html;

      } catch (e) {
        content.innerHTML = 'Error loading details';
      }
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
    }

    async function submitReview(action) {
      const reason = document.getElementById('reject-reason').value;
      if (action === 'reject' && !reason) {
        alert('Please provide a reason for rejection');
        return;
      }

      if (!confirm(`Are you sure you want to ${action} this user?`)) return;

      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/v1/admin/verifications/${currentUserId}/review`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ action, reason })
        });
        const data = await res.json();
        if (data.success) {
          alert('Success');
          closeReviewModal();
          fetchVerifications();
        } else {
          alert('Error: ' + data.message);
        }
      } catch (e) {
        alert('Connection error');
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
  </script>
</body>

</html>