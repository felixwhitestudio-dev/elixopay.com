<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Payment Test - Elixopay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-12 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-credit-card text-blue-600"></i>
                    Stripe Payment Test
                </h1>
                <p class="text-gray-600">Test Stripe integration with Elixopay</p>
            </div>

            <!-- Setup Instructions Alert -->
            <div id="setupAlert" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">Stripe Setup Required</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>To test payments, you need to:</p>
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                <li>Get API keys from <a href="https://dashboard.stripe.com/test/apikeys" target="_blank" class="underline">Stripe Dashboard</a></li>
                                <li>Update <code class="bg-yellow-100 px-1 rounded">backend/.env</code> with real keys</li>
                                <li>Restart backend server</li>
                            </ol>
                            <p class="mt-2">See <strong>STRIPE_SETUP.md</strong> for detailed instructions.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Payment Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-wallet"></i>
                        Create Payment
                    </h2>

                    <form id="paymentForm" class="space-y-4">
                        <!-- Amount -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Amount (THB)
                            </label>
                            <input 
                                type="number" 
                                id="amount" 
                                value="999.99"
                                step="0.01"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required
                            >
                        </div>

                        <!-- Currency -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Currency
                            </label>
                            <select 
                                id="currency" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="THB">THB - Thai Baht</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                            </select>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                            </label>
                            <input 
                                type="text" 
                                id="description" 
                                value="Test Payment - Premium Plan"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            >
                        </div>

                        <!-- Customer Email -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Customer Email
                            </label>
                            <input 
                                type="email" 
                                id="customerEmail" 
                                value="test@stripe.com"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            >
                        </div>

                        <!-- Customer Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Customer Name
                            </label>
                            <input 
                                type="text" 
                                id="customerName" 
                                value="Test Customer"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            >
                        </div>

                        <!-- Submit Button -->
                        <button 
                            type="submit" 
                            id="createPaymentBtn"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                            <i class="fas fa-money-bill-wave mr-2"></i>
                            Create Payment Intent
                        </button>
                    </form>

                    <!-- Payment Status -->
                    <div id="paymentStatus" class="mt-4 hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-green-800">Payment Intent Created!</h3>
                                    <p class="text-sm text-green-700 mt-1">
                                        Payment ID: <span id="paymentId" class="font-mono"></span>
                                    </p>
                                    <p class="text-sm text-green-700">
                                        Amount: <span id="paymentAmount" class="font-semibold"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="errorDisplay" class="mt-4 hidden">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-red-800">Error</h3>
                                    <p class="text-sm text-red-700 mt-1" id="errorMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Information -->
                <div class="space-y-6">
                    <!-- Test Cards -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">
                            <i class="fas fa-credit-card"></i>
                            Stripe Test Cards
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="border-l-4 border-green-500 bg-green-50 p-3">
                                <div class="font-mono text-sm font-semibold">4242 4242 4242 4242</div>
                                <div class="text-xs text-green-700">‚úÖ Successful payment</div>
                            </div>

                            <div class="border-l-4 border-red-500 bg-red-50 p-3">
                                <div class="font-mono text-sm font-semibold">4000 0000 0000 9995</div>
                                <div class="text-xs text-red-700">‚ùå Declined payment</div>
                            </div>

                            <div class="border-l-4 border-yellow-500 bg-yellow-50 p-3">
                                <div class="font-mono text-sm font-semibold">4000 0025 0000 3155</div>
                                <div class="text-xs text-yellow-700">üîê Requires authentication</div>
                            </div>
                        </div>

                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>For all cards:</strong></p>
                            <ul class="list-disc list-inside space-y-1 mt-2">
                                <li>Expiry: Any future date (e.g., 12/34)</li>
                                <li>CVC: Any 3 digits (e.g., 123)</li>
                                <li>ZIP: Any 5 digits (e.g., 12345)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Webhook Testing -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">
                            <i class="fas fa-webhook"></i>
                            Webhook Testing
                        </h2>
                        
                        <div class="space-y-3 text-sm">
                            <p class="text-gray-600">Test webhook events using Stripe CLI:</p>
                            
                            <div class="bg-gray-900 text-green-400 p-3 rounded font-mono text-xs overflow-x-auto">
                                <div># Install Stripe CLI</div>
                                <div>brew install stripe/stripe-cli/stripe</div>
                                <div class="mt-2"># Forward webhooks</div>
                                <div>stripe listen --forward-to \</div>
                                <div>  http://localhost:3000/api/v1/webhooks/stripe</div>
                                <div class="mt-2"># Trigger events</div>
                                <div>stripe trigger payment_intent.succeeded</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">
                            <i class="fas fa-link"></i>
                            Quick Links
                        </h2>
                        
                        <div class="space-y-2">
                            <a href="https://dashboard.stripe.com/test/apikeys" target="_blank" class="block text-blue-600 hover:text-blue-800">
                                <i class="fas fa-key mr-2"></i>Get API Keys
                            </a>
                            <a href="https://dashboard.stripe.com/test/payments" target="_blank" class="block text-blue-600 hover:text-blue-800">
                                <i class="fas fa-list mr-2"></i>View Payments
                            </a>
                            <a href="https://dashboard.stripe.com/test/webhooks" target="_blank" class="block text-blue-600 hover:text-blue-800">
                                <i class="fas fa-webhook mr-2"></i>Configure Webhooks
                            </a>
                            <a href="https://stripe.com/docs" target="_blank" class="block text-blue-600 hover:text-blue-800">
                                <i class="fas fa-book mr-2"></i>Stripe Docs
                            </a>
                            <a href="./STRIPE_SETUP.md" class="block text-blue-600 hover:text-blue-800">
                                <i class="fas fa-file-alt mr-2"></i>Setup Guide
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Display -->
            <div id="responseDisplay" class="mt-6 hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-code"></i>
                        API Response
                    </h2>
                    <pre id="responseJson" class="bg-gray-900 text-green-400 p-4 rounded overflow-x-auto text-sm"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api-config.js"></script>
    <script>
        let authToken = null;

        // Auto-login on page load
        async function autoLogin() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'demo@elixopay.com',
                        password: 'demo1234'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    authToken = result.data.token;
                    console.log('‚úÖ Auto-login successful');
                } else {
                    console.error('‚ùå Auto-login failed:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Auto-login error:', error);
            }
        }

        // Create Payment Intent
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!authToken) {
                showError('Please wait, authenticating...');
                await autoLogin();
                if (!authToken) {
                    showError('Authentication failed. Please refresh the page.');
                    return;
                }
            }

            const btn = document.getElementById('createPaymentBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';

            const amount = parseFloat(document.getElementById('amount').value);
            const currency = document.getElementById('currency').value;
            const description = document.getElementById('description').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const customerName = document.getElementById('customerName').value;

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/payments`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount,
                        currency,
                        description,
                        customer_email: customerEmail,
                        customer_name: customerName,
                        metadata: {
                            test: 'true',
                            source: 'stripe-test-page'
                        }
                    })
                });

                const result = await response.json();

                // Show response
                document.getElementById('responseDisplay').classList.remove('hidden');
                document.getElementById('responseJson').textContent = JSON.stringify(result, null, 2);

                if (result.success) {
                    showSuccess(result.data.payment);
                    hideError();
                } else {
                    showError(result.error.message + (result.error.details ? ` - ${result.error.details}` : ''));
                }
            } catch (error) {
                showError(`Request failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-money-bill-wave mr-2"></i>Create Payment Intent';
            }
        });

        function showSuccess(payment) {
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.classList.remove('hidden');
            
            document.getElementById('paymentId').textContent = payment.id;
            document.getElementById('paymentAmount').textContent = 
                `${payment.amount} ${payment.currency}`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            
            document.getElementById('paymentStatus').classList.add('hidden');
        }

        function hideError() {
            document.getElementById('errorDisplay').classList.add('hidden');
        }

        // Initialize
        autoLogin();
    </script>
</body>
</html>
