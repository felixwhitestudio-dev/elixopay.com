<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - Elixopay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Loading State -->
    <div id="loading" class="text-center">
        <div class="spinner w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-500 font-medium">Loading secure checkout...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center max-w-md w-full glass-card p-8 rounded-2xl">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">Checkout Error</h2>
        <p id="error-msg" class="text-gray-600 mb-6">Something went wrong.</p>
        <button onclick="window.history.back()" class="text-purple-600 font-medium hover:underline">Go Back</button>
    </div>

    <!-- Payment Card -->
    <div id="checkout-card"
        class="hidden w-full max-w-md glass-card rounded-3xl overflow-hidden shadow-2xl transform transition-all">
        <!-- Header -->
        <div class="bg-gray-50 p-6 border-b border-gray-100 flex items-center justify-between">
            <div class="flex items-center">
                <div
                    class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center text-white font-bold text-sm mr-3">
                    E</div>
                <span class="font-bold text-gray-800 text-lg">Elixopay</span>
            </div>
            <div class="flex items-center text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-md">
                <i class="fas fa-lock mr-1.5"></i> Secure
            </div>
        </div>

        <!-- Content -->
        <div class="p-8">
            <div class="text-center mb-8">
                <p class="text-sm text-gray-500 uppercase tracking-widest font-semibold mb-2">Payment to</p>
                <h2 id="merchant-name" class="text-xl font-bold text-gray-900 mb-4">Loading...</h2>
                <div class="text-4xl font-black text-gray-900 flex items-center justify-center">
                    <span id="amount" class="tracking-tight">0.00</span>
                    <span id="currency" class="text-lg text-gray-500 ml-2 font-bold">THB</span>
                </div>
                <p id="description" class="text-gray-500 text-sm mt-2 italic px-4"></p>
            </div>

            <!-- Pay Button -->
            <button id="pay-btn" onclick="processPayment()"
                class="w-full py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-bold text-lg hover:shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center">
                <span>Pay Now</span>
                <i class="fas fa-arrow-right ml-2 opacity-80"></i>
            </button>

            <p id="status-msg" class="mt-4 text-center text-sm font-medium hidden"></p>
        </div>

        <!-- Footer -->
        <div class="text-center bg-gray-50 p-4 border-t border-gray-100">
            <p class="text-xs text-gray-400">Powered by Elixopay Secure Payment</p>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const API_BASE = 'http://localhost:5001'; // Should match api-config logic in real app
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Check Auth
        // Simple cookie check from document (not secure but okay for UI switch)
        const isLoggedIn = document.cookie.includes('access_token');
        const payBtn = document.getElementById('pay-btn');
        let stripe, elements;

        async function init() {
            if (!token) {
                showError('Invalid payment link. No token provided.');
                return;
            }

            try {
                // Fetch Payment Details
                const response = await fetch(`${API_BASE}/api/v1/payments/session/${token}`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.error?.message || 'Failed to load payment session');
                    return;
                }

                const payment = data.data;

                if (payment.status !== 'pending') {
                    showError(`This payment is already ${payment.status}.`);
                    return;
                }

                document.getElementById('merchant-name').textContent = payment.merchant.name;
                document.getElementById('amount').textContent = parseFloat(payment.amount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                document.getElementById('currency').textContent = payment.currency;
                document.getElementById('description').textContent = payment.description || '';

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('checkout-card').classList.remove('hidden');

                // Ensure container exists for Stripe
                const paymentContainer = document.createElement('div');
                paymentContainer.id = 'payment-element';
                paymentContainer.className = 'mb-6';
                document.getElementById('description').parentNode.parentNode.insertBefore(paymentContainer, payBtn);

                if (payment.clientSecret && payment.stripePublicKey) {
                    // Initialize Stripe
                    stripe = Stripe(payment.stripePublicKey);
                    const appearance = { theme: 'stripe' };
                    elements = stripe.elements({ appearance, clientSecret: payment.clientSecret });
                    const paymentElement = elements.create('payment');
                    paymentElement.mount('#payment-element');
                    payBtn.textContent = 'Pay now';
                } else if (!isLoggedIn) {
                    // Fallback for Wallet payment if not logged in
                    payBtn.textContent = 'Log in to Pay';
                    // Use standard encodeURIComponent for nested redirects
                    // This ensures: login -> redirects to checkout -> checkout has original query params
                    payBtn.onclick = () => window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.href)}`;
                }

            } catch (error) {
                console.error(error);
                showError('Connection error. Please try again.');
            }
        }

        async function processPayment() {
            payBtn.disabled = true;
            payBtn.innerHTML = '<div class="spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full mr-2"></div> Processing...';

            // Stripe Payment
            if (stripe && elements) {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.href.split('?')[0] + '?status=success&token=' + token,
                    },
                });

                if (error) {
                    const msg = document.getElementById('status-msg');
                    msg.textContent = error.message;
                    msg.classList.remove('hidden');
                    msg.classList.add('text-red-500');
                    payBtn.disabled = false;
                    payBtn.innerHTML = 'Pay Now';
                }
                // If success, stripe redirects automatically
                return;
            }

            // Wallet Payment Logic (Legacy / Internal)
            if (!isLoggedIn) return;

            try {
                // Execute Payment
                // Cross-origin requires credentials: 'include' if relying on cookies
                const response = await fetch(`${API_BASE}/api/v1/payments/session/${token}/pay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    payBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Payment Successful!';
                    payBtn.classList.remove('from-purple-600', 'to-blue-600');
                    payBtn.classList.add('bg-green-500', 'text-white');

                    setTimeout(() => {
                        window.location.href = result.data.redirect_url;
                    }, 1500);
                } else {
                    throw new Error(result.error?.message || 'Payment failed');
                }

            } catch (error) {
                const msg = document.getElementById('status-msg');
                msg.textContent = error.message;
                msg.classList.remove('hidden');
                msg.classList.add('text-red-500');

                payBtn.disabled = false;
                payBtn.innerHTML = 'Try Again';
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('checkout-card').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-msg').textContent = msg;
        }

        init();
    </script>
</body>

</html>